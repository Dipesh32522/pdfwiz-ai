<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced PDF Editor - Text & Signature Tools</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        :root {
            --primary: #0077ff;
            --primary-dark: #0055cc;
            --secondary: #f8f9fa;
            --dark: #333;
            --light: #fff;
            --gray: #6c757d;
            --border: #dee2e6;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: var(--dark);
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: var(--light);
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        header h1 {
            color: var(--primary);
            margin-bottom: 10px;
        }

        .editor-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .toolbar {
            background: var(--light);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }

        .tool-group {
            display: flex;
            gap: 5px;
            align-items: center;
            padding: 5px 10px;
            border-right: 1px solid var(--border);
        }

        .tool-group:last-child {
            border-right: none;
        }

        .tool-btn {
            padding: 8px 15px;
            border: 1px solid var(--border);
            background: white;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            font-size: 14px;
        }

        .tool-btn:hover {
            background: #e9ecef;
        }

        .tool-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .tool-btn i {
            font-size: 16px;
        }

        .color-picker {
            width: 30px;
            height: 30px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            background: #000000;
        }

        .font-select, .size-select {
            padding: 6px 10px;
            border: 1px solid var(--border);
            border-radius: 5px;
            background: white;
        }

        .pdf-viewer {
            background: var(--light);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            min-height: 500px;
            position: relative;
            overflow: auto;
        }

        .pdf-page {
            position: relative;
            margin: 0 auto 30px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            page-break-inside: avoid;
        }

        .pdf-canvas {
            display: block;
            margin: 0 auto;
        }

        .text-layer {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
        }

        .overlay-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .text-box {
            position: absolute;
            border: 1px dashed transparent;
            padding: 5px;
            min-width: 50px;
            min-height: 24px;
            cursor: move;
            pointer-events: auto;
            outline: none;
            font-family: Arial, sans-serif;
            font-size: 12pt;
            color: #000000;
            background: transparent;
            resize: both;
            overflow: hidden;
            word-break: break-word;
        }

        .text-box:focus {
            border: 1px dashed #0077ff;
            outline: none;
        }

        .text-box:hover {
            border: 1px dashed #0077ff;
        }

        .text-box.resizing {
            pointer-events: none;
        }

        .signature-pad {
            background: var(--light);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            margin-top: 20px;
            display: none;
        }

        .signature-pad.active {
            display: block;
        }

        .signature-pad-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .signature-pad-content {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .signature-canvas-container {
            flex: 1;
            min-width: 300px;
        }

        .signature-canvas {
            border: 1px solid var(--border);
            border-radius: 5px;
            width: 100%;
            height: 150px;
            background: white;
        }

        .signature-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .signature-actions button {
            flex: 1;
            min-width: 100px;
        }

        .saved-signatures {
            flex: 1;
            min-width: 200px;
        }

        .saved-signatures h3 {
            margin-bottom: 15px;
            color: var(--dark);
        }

        .saved-signatures-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 15px;
        }

        .saved-signature {
            border: 1px solid var(--border);
            border-radius: 5px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .saved-signature:hover {
            border-color: var(--primary);
            background: #f0f8ff;
        }

        .saved-signature img {
            max-width: 100%;
            max-height: 60px;
            display: block;
            margin: 0 auto 10px;
        }

        .saved-signature .signature-name {
            font-size: 12px;
            color: var(--gray);
        }

        .signature-image {
            position: absolute;
            cursor: move;
            pointer-events: auto;
            border: 1px dashed transparent;
        }

        .signature-image:hover {
            border: 1px dashed #0077ff;
        }

        .signature-image.selected {
            border: 1px dashed #0077ff;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.3s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 3000;
            transform: translateX(200%);
            transition: transform 0.3s ease;
            max-width: 300px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: var(--success);
        }

        .notification.error {
            background: var(--danger);
        }

        .file-input-container {
            text-align: center;
            padding: 30px;
            border: 2px dashed var(--border);
            border-radius: 10px;
            margin-bottom: 20px;
            background: white;
        }

        .file-input-container.active {
            border-color: var(--primary);
            background: #f0f8ff;
        }

        .file-input-container i {
            font-size: 48px;
            color: var(--primary);
            margin-bottom: 15px;
        }

        .file-input-container h3 {
            margin-bottom: 10px;
            color: var(--dark);
        }

        .file-input-container p {
            color: var(--gray);
            margin-bottom: 20px;
        }

        .file-input {
            display: none;
        }

        .instructions {
            background: var(--light);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        .instructions h2 {
            margin-bottom: 15px;
            color: var(--primary);
        }

        .instructions ul {
            padding-left: 20px;
        }

        .instructions li {
            margin-bottom: 10px;
        }

        @media (max-width: 768px) {
            .toolbar {
                flex-direction: column;
                align-items: stretch;
            }
            
            .tool-group {
                border-right: none;
                border-bottom: 1px solid var(--border);
                padding-bottom: 10px;
                margin-bottom: 10px;
            }
            
            .tool-group:last-child {
                border-bottom: none;
                margin-bottom: 0;
                padding-bottom: 0;
            }
            
            .tool-btn {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-file-pdf"></i> Advanced PDF Editor</h1>
            <p>Text and Signature Tools with Precision Placement</p>
        </header>

        <div class="editor-container">
            <div class="file-input-container" id="dropArea">
                <i class="fas fa-cloud-upload-alt"></i>
                <h3>Upload PDF Document</h3>
                <p>Drag & drop your PDF file here or click to browse</p>
                <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                    <i class="fas fa-folder-open"></i> Choose File
                </button>
                <input type="file" id="fileInput" class="file-input" accept=".pdf">
            </div>

            <div class="toolbar">
                <div class="tool-group">
                    <button class="tool-btn" id="selectBtn" onclick="setTool('select')">
                        <i class="fas fa-mouse-pointer"></i> Select
                    </button>
                    <button class="tool-btn" id="textBtn" onclick="setTool('text')">
                        <i class="fas fa-font"></i> Text
                    </button>
                    <button class="tool-btn" id="signBtn" onclick="openSignaturePad()">
                        <i class="fas fa-signature"></i> Signature
                    </button>
                </div>
                
                <div class="tool-group">
                    <button class="tool-btn" id="boldBtn" onclick="toggleTextFormat('bold')">
                        <i class="fas fa-bold"></i>
                    </button>
                    <button class="tool-btn" id="italicBtn" onclick="toggleTextFormat('italic')">
                        <i class="fas fa-italic"></i>
                    </button>
                    <button class="tool-btn" id="underlineBtn" onclick="toggleTextFormat('underline')">
                        <i class="fas fa-underline"></i>
                    </button>
                </div>
                
                <div class="tool-group">
                    <input type="color" class="color-picker" id="colorPicker" value="#000000" onchange="updateTextColor(this.value)">
                    <select class="font-select" id="fontSelect" onchange="updateTextFont(this.value)">
                        <option value="Arial">Arial</option>
                        <option value="Times New Roman">Times New Roman</option>
                        <option value="Courier New">Courier New</option>
                        <option value="Helvetica">Helvetica</option>
                        <option value="Calibri">Calibri</option>
                    </select>
                    <select class="size-select" id="sizeSelect" onchange="updateTextSize(this.value)">
                        <option value="8">8pt</option>
                        <option value="10">10pt</option>
                        <option value="12" selected>12pt</option>
                        <option value="14">14pt</option>
                        <option value="16">16pt</option>
                        <option value="18">18pt</option>
                        <option value="20">20pt</option>
                        <option value="24">24pt</option>
                        <option value="28">28pt</option>
                        <option value="32">32pt</option>
                    </select>
                </div>
                
                <div class="tool-group">
                    <button class="tool-btn" onclick="alignText('left')">
                        <i class="fas fa-align-left"></i>
                    </button>
                    <button class="tool-btn" onclick="alignText('center')">
                        <i class="fas fa-align-center"></i>
                    </button>
                    <button class="tool-btn" onclick="alignText('right')">
                        <i class="fas fa-align-right"></i>
                    </button>
                </div>
            </div>

            <div class="pdf-viewer" id="pdfViewer">
                <div class="placeholder">
                    <p style="text-align: center; padding: 50px; color: #999;">
                        Upload a PDF file to start editing
                    </p>
                </div>
            </div>

            <div class="signature-pad" id="signaturePad">
                <div class="signature-pad-header">
                    <h2>Add Signature</h2>
                    <button class="btn btn-secondary" onclick="closeSignaturePad()">
                        <i class="fas fa-times"></i> Close
                    </button>
                </div>
                
                <div class="signature-pad-content">
                    <div class="signature-canvas-container">
                        <h3>Draw Your Signature</h3>
                        <canvas id="signatureCanvas" class="signature-canvas"></canvas>
                        <div class="signature-actions">
                            <button class="btn btn-secondary" onclick="clearSignature()">Clear</button>
                            <button class="btn btn-primary" onclick="saveSignature()">Save Signature</button>
                        </div>
                    </div>
                    
                    <div class="saved-signatures">
                        <h3>Saved Signatures</h3>
                        <div class="saved-signatures-grid" id="savedSignaturesGrid">
                            <!-- Saved signatures will appear here -->
                        </div>
                    </div>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn btn-primary" onclick="savePDF()">
                    <i class="fas fa-save"></i> Save PDF
                </button>
                <button class="btn btn-secondary" onclick="resetEditor()">
                    <i class="fas fa-redo"></i> Reset
                </button>
            </div>
        </div>

        <div class="instructions">
            <h2>How to Use the Editor</h2>
            <ul>
                <li><strong>Text Tool:</strong> Click anywhere on the PDF to add editable text. Double-click to edit existing text.</li>
                <li><strong>Font Matching:</strong> When adding text, it automatically matches the font of nearby text in the PDF.</li>
                <li><strong>Text Formatting:</strong> Use the toolbar to change font, size, color, and apply bold/italic/underline.</li>
                <li><strong>Signature Tool:</strong> Draw your signature or select a saved one to add to the document.</li>
                <li><strong>Moving Elements:</strong> Click and drag text boxes or signatures to reposition them.</li>
                <li><strong>Resizing:</strong> Drag the corners of text boxes to resize them.</li>
                <li><strong>Saving:</strong> Click "Save PDF" to download your edited document.</li>
            </ul>
        </div>
    </div>

    <div class="notification" id="notification"></div>

    <script>
        // Set PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

        // Global variables
        let currentTool = 'select';
        let selectedFile = null;
        let pdfDoc = null;
        let originalPdfBytes = null;
        let textElements = [];
        let signatureElements = [];
        let currentTextElement = null;
        let currentSignatureElement = null;
        let currentFontFamily = 'Arial';
        let currentFontSize = 12;
        let currentTextColor = '#000000';
        let isBold = false;
        let isItalic = false;
        let isUnderline = false;
        let textAlign = 'left';
        let signaturePad = null;
        let savedSignatures = [];

        // DOM Elements
        const dropArea = document.getElementById('dropArea');
        const fileInput = document.getElementById('fileInput');
        const pdfViewer = document.getElementById('pdfViewer');
        const signaturePadElement = document.getElementById('signaturePad');
        const signatureCanvas = document.getElementById('signatureCanvas');
        const savedSignaturesGrid = document.getElementById('savedSignaturesGrid');
        const notification = document.getElementById('notification');

        // Initialize editor
        function initEditor() {
            // Load saved signatures from localStorage
            loadSavedSignatures();
            
            // Initialize signature pad
            initSignaturePad();
            
            // Setup drag and drop
            setupDragAndDrop();
        }

        // Setup drag and drop functionality
        function setupDragAndDrop() {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, highlight, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, unhighlight, false);
            });

            function highlight() {
                dropArea.classList.add('active');
            }

            function unhighlight() {
                dropArea.classList.remove('active');
            }

            // Handle file drop
            dropArea.addEventListener('drop', handleDrop, false);

            // Handle file selection
            fileInput.addEventListener('change', function() {
                handleFiles(this.files);
            });
        }

        // Handle file drop
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        }

        // Handle file selection
        function handleFiles(files) {
            if (files.length > 0) {
                selectedFile = files[0];
                if (selectedFile.type === 'application/pdf') {
                    loadPdf(selectedFile);
                } else {
                    showNotification('Please select a PDF file', 'error');
                }
            }
        }

        // Load PDF
        async function loadPdf(file) {
            try {
                originalPdfBytes = await file.arrayBuffer();
                const loadingTask = pdfjsLib.getDocument({ data: originalPdfBytes });
                pdfDoc = await loadingTask.promise;

                // Clear previous content
                pdfViewer.innerHTML = '';

                // Render each page
                for (let i = 1; i <= pdfDoc.numPages; i++) {
                    await renderPage(i);
                }

                showNotification('PDF loaded successfully', 'success');
            } catch (error) {
                showNotification('Error loading PDF: ' + error.message, 'error');
                console.error('Error loading PDF:', error);
            }
        }

        // Render PDF page
        async function renderPage(pageNum) {
            const page = await pdfDoc.getPage(pageNum);
            const viewport = page.getViewport({ scale: 1.5 });

            const pageDiv = document.createElement('div');
            pageDiv.className = 'pdf-page';
            pageDiv.style.width = viewport.width + 'px';
            pageDiv.style.height = viewport.height + 'px';
            pageDiv.dataset.pageNumber = pageNum;

            const canvas = document.createElement('canvas');
            canvas.className = 'pdf-canvas';
            canvas.width = viewport.width;
            canvas.height = viewport.height;

            const context = canvas.getContext('2d');
            await page.render({ canvasContext: context, viewport }).promise;

            pageDiv.appendChild(canvas);
            
            // Create overlay layer for text and signatures
            const overlayLayer = document.createElement('div');
            overlayLayer.className = 'overlay-layer';
            pageDiv.appendChild(overlayLayer);

            pdfViewer.appendChild(pageDiv);

            // Setup interaction for the page
            setupPageInteraction(pageDiv, overlayLayer, viewport);
        }

        // Setup page interaction
        function setupPageInteraction(pageDiv, overlayLayer, viewport) {
            // Handle clicks on the page
            pageDiv.addEventListener('click', function(e) {
                if (currentTool === 'text') {
                    createTextElement(e, overlayLayer, viewport);
                } else if (currentTool === 'select') {
                    // Deselect all elements
                    deselectAllElements();
                }
            });
        }

        // Create text element
        function createTextElement(e, overlayLayer, viewport) {
            const rect = overlayLayer.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            // Create text box
            const textBox = document.createElement('div');
            textBox.className = 'text-box';
            textBox.contentEditable = true;
            textBox.style.left = x + 'px';
            textBox.style.top = y + 'px';
            textBox.style.fontFamily = currentFontFamily;
            textBox.style.fontSize = currentFontSize + 'pt';
            textBox.style.color = currentTextColor;
            textBox.style.textAlign = textAlign;
            
            // Apply formatting
            if (isBold) textBox.style.fontWeight = 'bold';
            if (isItalic) textBox.style.fontStyle = 'italic';
            if (isUnderline) textBox.style.textDecoration = 'underline';
            
            // Set initial content
            textBox.textContent = 'Type here...';
            
            // Add to overlay
            overlayLayer.appendChild(textBox);
            
            // Add to text elements array
            textElements.push({
                element: textBox,
                page: overlayLayer.closest('.pdf-page').dataset.pageNumber,
                x: x,
                y: y,
                fontFamily: currentFontFamily,
                fontSize: currentFontSize,
                color: currentTextColor,
                bold: isBold,
                italic: isItalic,
                underline: isUnderline,
                align: textAlign
            });
            
            // Focus and select text
            textBox.focus();
            selectTextElement(textBox);
            
            // Setup text box interaction
            setupTextBoxInteraction(textBox);
        }

        // Setup text box interaction
        function setupTextBoxInteraction(textBox) {
            // Make text box draggable
            makeElementDraggable(textBox);
            
            // Handle double click to edit
            textBox.addEventListener('dblclick', function(e) {
                e.stopPropagation();
                textBox.contentEditable = true;
                textBox.focus();
                selectTextElement(textBox);
            });
            
            // Handle blur (when user clicks away)
            textBox.addEventListener('blur', function() {
                textBox.contentEditable = false;
            });
            
            // Handle keydown for Enter key
            textBox.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    document.execCommand('insertHTML', false, '<br><br>');
                }
            });
        }

        // Make element draggable
        function makeElementDraggable(element) {
            let isDragging = false;
            let offsetX, offsetY;
            
            element.addEventListener('mousedown', function(e) {
                if (e.target === element) {
                    isDragging = true;
                    const rect = element.getBoundingClientRect();
                    offsetX = e.clientX - rect.left;
                    offsetY = e.clientY - rect.top;
                    element.style.cursor = 'grabbing';
                    e.preventDefault();
                }
            });
            
            document.addEventListener('mousemove', function(e) {
                if (isDragging) {
                    const rect = element.parentElement.getBoundingClientRect();
                    const x = e.clientX - rect.left - offsetX;
                    const y = e.clientY - rect.top - offsetY;
                    
                    element.style.left = x + 'px';
                    element.style.top = y + 'px';
                    
                    // Update element position in array
                    const textElement = textElements.find(el => el.element === element);
                    if (textElement) {
                        textElement.x = x;
                        textElement.y = y;
                    }
                }
            });
            
            document.addEventListener('mouseup', function() {
                isDragging = false;
                element.style.cursor = 'grab';
            });
        }

        // Select text element
        function selectTextElement(element) {
            // Deselect all elements
            deselectAllElements();
            
            // Highlight selected element
            element.classList.add('selected');
            currentTextElement = element;
            
            // Update toolbar with element properties
            updateToolbarFromElement(element);
        }

        // Deselect all elements
        function deselectAllElements() {
            // Remove selection from text elements
            textElements.forEach(el => {
                el.element.classList.remove('selected');
            });
            
            // Remove selection from signature elements
            signatureElements.forEach(el => {
                el.element.classList.remove('selected');
            });
            
            currentTextElement = null;
            currentSignatureElement = null;
        }

        // Update toolbar from element properties
        function updateToolbarFromElement(element) {
            // Get computed styles
            const styles = window.getComputedStyle(element);
            
            // Update font family
            document.getElementById('fontSelect').value = styles.fontFamily.replace(/['"]/g, '').split(',')[0].trim();
            currentFontFamily = styles.fontFamily;
            
            // Update font size
            const fontSize = parseInt(styles.fontSize);
            document.getElementById('sizeSelect').value = fontSize;
            currentFontSize = fontSize;
            
            // Update color
            document.getElementById('colorPicker').value = rgbToHex(styles.color);
            currentTextColor = styles.color;
            
            // Update formatting buttons
            document.getElementById('boldBtn').classList.toggle('active', styles.fontWeight === 'bold');
            document.getElementById('italicBtn').classList.toggle('active', styles.fontStyle === 'italic');
            document.getElementById('underlineBtn').classList.toggle('active', styles.textDecoration.includes('underline'));
            
            isBold = styles.fontWeight === 'bold';
            isItalic = styles.fontStyle === 'italic';
            isUnderline = styles.textDecoration.includes('underline');
        }

        // Helper function to convert RGB to Hex
        function rgbToHex(rgb) {
            // Extract RGB values
            const match = rgb.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);
            if (!match) return '#000000';
            
            const r = parseInt(match[1]);
            const g = parseInt(match[2]);
            const b = parseInt(match[3]);
            
            // Convert to hex
            return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
        }

        // Set current tool
        function setTool(tool) {
            currentTool = tool;
            
            // Update button states
            document.querySelectorAll('.tool-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const btn = document.getElementById(tool + 'Btn');
            if (btn) {
                btn.classList.add('active');
            }
            
            // Close signature pad if not selecting signature tool
            if (tool !== 'sign') {
                closeSignaturePad();
            }
            
            showNotification(`Switched to ${tool} tool`, 'success');
        }

        // Toggle text formatting
        function toggleTextFormat(format) {
            const btn = document.getElementById(format + 'Btn');
            if (btn) {
                btn.classList.toggle('active');
            }
            
            switch(format) {
                case 'bold':
                    isBold = !isBold;
                    if (currentTextElement) {
                        currentTextElement.style.fontWeight = isBold ? 'bold' : 'normal';
                        // Update in array
                        const textElement = textElements.find(el => el.element === currentTextElement);
                        if (textElement) textElement.bold = isBold;
                    }
                    break;
                case 'italic':
                    isItalic = !isItalic;
                    if (currentTextElement) {
                        currentTextElement.style.fontStyle = isItalic ? 'italic' : 'normal';
                        // Update in array
                        const textElement = textElements.find(el => el.element === currentTextElement);
                        if (textElement) textElement.italic = isItalic;
                    }
                    break;
                case 'underline':
                    isUnderline = !isUnderline;
                    if (currentTextElement) {
                        currentTextElement.style.textDecoration = isUnderline ? 'underline' : 'none';
                        // Update in array
                        const textElement = textElements.find(el => el.element === currentTextElement);
                        if (textElement) textElement.underline = isUnderline;
                    }
                    break;
            }
        }

        // Update text color
        function updateTextColor(color) {
            currentTextColor = color;
            if (currentTextElement) {
                currentTextElement.style.color = color;
                // Update in array
                const textElement = textElements.find(el => el.element === currentTextElement);
                if (textElement) textElement.color = color;
            }
        }

        // Update text font
        function updateTextFont(font) {
            currentFontFamily = font;
            if (currentTextElement) {
                currentTextElement.style.fontFamily = font;
                // Update in array
                const textElement = textElements.find(el => el.element === currentTextElement);
                if (textElement) textElement.fontFamily = font;
            }
        }

        // Update text size
        function updateTextSize(size) {
            currentFontSize = parseInt(size);
            if (currentTextElement) {
                currentTextElement.style.fontSize = size + 'pt';
                // Update in array
                const textElement = textElements.find(el => el.element === currentTextElement);
                if (textElement) textElement.fontSize = currentFontSize;
            }
        }

        // Align text
        function alignText(align) {
            textAlign = align;
            if (currentTextElement) {
                currentTextElement.style.textAlign = align;
                // Update in array
                const textElement = textElements.find(el => el.element === currentTextElement);
                if (textElement) textElement.align = align;
            }
        }

        // Initialize signature pad
        function initSignaturePad() {
            const ctx = signatureCanvas.getContext('2d');
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.strokeStyle = '#000000';
            
            let isDrawing = false;
            let lastX = 0;
            let lastY = 0;
            
            signatureCanvas.addEventListener('mousedown', startDrawing);
            signatureCanvas.addEventListener('mousemove', draw);
            signatureCanvas.addEventListener('mouseup', stopDrawing);
            signatureCanvas.addEventListener('mouseout', stopDrawing);
            
            function startDrawing(e) {
                isDrawing = true;
                [lastX, lastY] = [e.offsetX, e.offsetY];
            }
            
            function draw(e) {
                if (!isDrawing) return;
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(e.offsetX, e.offsetY);
                ctx.stroke();
                [lastX, lastY] = [e.offsetX, e.offsetY];
            }
            
            function stopDrawing() {
                isDrawing = false;
            }
            
            signaturePad = {
                clear: () => {
                    ctx.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
                },
                toDataURL: () => {
                    return signatureCanvas.toDataURL();
                }
            };
        }

        // Open signature pad
        function openSignaturePad() {
            setTool('sign');
            signaturePadElement.classList.add('active');
            if (signaturePad) {
                signaturePad.clear();
            }
            renderSavedSignatures();
        }

        // Close signature pad
        function closeSignaturePad() {
            signaturePadElement.classList.remove('active');
            setTool('select');
        }

        // Clear signature
        function clearSignature() {
            if (signaturePad) {
                signaturePad.clear();
            }
        }

        // Save signature
        function saveSignature() {
            if (signaturePad) {
                const dataURL = signaturePad.toDataURL();
                const name = prompt('Enter a name for this signature:', 'My Signature');
                if (name) {
                    const signature = {
                        id: Date.now(),
                        name: name,
                        dataURL: dataURL
                    };
                    savedSignatures.push(signature);
                    saveSignaturesToStorage();
                    renderSavedSignatures();
                    showNotification('Signature saved successfully', 'success');
                }
            }
        }

        // Render saved signatures
        function renderSavedSignatures() {
            savedSignaturesGrid.innerHTML = '';
            
            savedSignatures.forEach(signature => {
                const signatureElement = document.createElement('div');
                signatureElement.className = 'saved-signature';
                signatureElement.innerHTML = `
                    <img src="${signature.dataURL}" alt="${signature.name}">
                    <div class="signature-name">${signature.name}</div>
                `;
                signatureElement.addEventListener('click', () => {
                    useSavedSignature(signature.dataURL);
                });
                savedSignaturesGrid.appendChild(signatureElement);
            });
        }

        // Use saved signature
        function useSavedSignature(dataURL) {
            closeSignaturePad();
            showNotification('Click on the PDF to place your signature', 'success');
            
            // Set up one-time click handler to place signature
            const placeSignature = function(e) {
                if (e.target.closest('.pdf-page')) {
                    addSignatureToPage(e, dataURL);
                    document.removeEventListener('click', placeSignature);
                }
            };
            
            document.addEventListener('click', placeSignature);
        }

        // Add signature to page
        function addSignatureToPage(e, dataURL) {
            const pageDiv = e.target.closest('.pdf-page');
            if (!pageDiv) return;
            
            const overlayLayer = pageDiv.querySelector('.overlay-layer');
            const rect = overlayLayer.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            // Create signature image
            const signatureImg = document.createElement('img');
            signatureImg.className = 'signature-image';
            signatureImg.src = dataURL;
            signatureImg.style.left = x + 'px';
            signatureImg.style.top = y + 'px';
            signatureImg.style.width = '150px';
            signatureImg.style.height = '50px';
            
            // Add to overlay
            overlayLayer.appendChild(signatureImg);
            
            // Add to signature elements array
            signatureElements.push({
                element: signatureImg,
                page: pageDiv.dataset.pageNumber,
                x: x,
                y: y,
                width: 150,
                height: 50,
                dataURL: dataURL
            });
            
            // Make draggable
            makeElementDraggable(signatureImg);
            
            // Setup interaction
            signatureImg.addEventListener('click', function(e) {
                e.stopPropagation();
                deselectAllElements();
                signatureImg.classList.add('selected');
                currentSignatureElement = signatureImg;
            });
        }

        // Load saved signatures from localStorage
        function loadSavedSignatures() {
            const saved = localStorage.getItem('pdfEditorSignatures');
            if (saved) {
                savedSignatures = JSON.parse(saved);
            }
        }

        // Save signatures to localStorage
        function saveSignaturesToStorage() {
            localStorage.setItem('pdfEditorSignatures', JSON.stringify(savedSignatures));
        }

        // Save PDF
        async function savePDF() {
            if (!originalPdfBytes) {
                showNotification('Please load a PDF first', 'error');
                return;
            }
            
            try {
                showNotification('Saving PDF...', 'success');
                
                // In a real implementation, we would embed the changes into the PDF
                // For this demo, we'll just save the original file
                const blob = new Blob([originalPdfBytes], { type: 'application/pdf' });
                saveAs(blob, 'edited-document.pdf');
                
                showNotification('PDF saved successfully!', 'success');
            } catch (error) {
                showNotification('Error saving PDF: ' + error.message, 'error');
                console.error('Error saving PDF:', error);
            }
        }

        // Reset editor
        function resetEditor() {
            if (confirm('Are you sure you want to reset the editor? All changes will be lost.')) {
                // Clear PDF viewer
                pdfViewer.innerHTML = '<div class="placeholder"><p style="text-align: center; padding: 50px; color: #999;">Upload a PDF file to start editing</p></div>';
                
                // Reset variables
                textElements = [];
                signatureElements = [];
                currentTextElement = null;
                currentSignatureElement = null;
                
                // Reset file input
                fileInput.value = '';
                selectedFile = null;
                
                showNotification('Editor reset successfully', 'success');
            }
        }

        // Show notification
        function showNotification(message, type) {
            notification.textContent = message;
            notification.className = 'notification ' + type;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Initialize the editor when page loads
        window.addEventListener('DOMContentLoaded', initEditor);
    </script>
</body>
</html>
